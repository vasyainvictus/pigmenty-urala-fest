{# Этот шаблон отображает АККОРДЕОН участников и форму назначения победителя #}

{# Форма назначения победителя (без изменений) #}
<form action="{{ url_for('admin.assign_winners') }}" method="POST" class="bg-light p-3 rounded mb-3">
    <input type="hidden" name="contest_id" value="{{ contest.id }}">
    <input type="hidden" name="experience_category" value="{{ exp_category }}">
    <div class="row align-items-end g-2">
        <div class="col-sm-8 col-md-9"><label class="form-label fw-bold small">Назначить победителя:</label>{% set winner_participant = (participants|selectattr('confirmed_place', 'equalto', 1)|first) %}{% set current_winner_id = winner_participant.participation.id if winner_participant else 0 %}<select name="place_1" class="form-select form-select-sm"><option value="">-- Не выбрано --</option>{% for p_data in participants %}<option value="{{ p_data.participation.id }}" {{ 'selected' if current_winner_id == p_data.participation.id }}>{{ p_data.participant.nickname or p_data.participant.code }} ({{ p_data.final_score }})</option>{% endfor %}</select></div>
        <div class="col-sm-4 col-md-3"><button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button></div>
    </div>
</form>

{# --- НАЧАЛО: АККОРДЕОН С РЕЗУЛЬТАТАМИ УЧАСТНИКОВ --- #}
<div class="accordion accordion-flush" id="participantAccordion-{{ contest.id }}-{{ exp_category }}">
{% for p_data in participants %}
    <div class="accordion-item participant-item" data-search-text="{{ (p_data.participant.nickname or '')|lower }} {{ p_data.participant.code|lower }}">
        <h2 class="accordion-header" id="p-heading-{{ p_data.participation.id }}">
            <button class="accordion-button collapsed p-3" type="button" data-bs-toggle="collapse" data-bs-target="#p-collapse-{{ p_data.participation.id }}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">{{ p_data.participant.nickname or p_data.participant.code }}</span>
                        {% if p_data.confirmed_place %}<span class="badge bg-warning text-dark ms-2"><i class="bi bi-trophy-fill me-1"></i>Победитель</span>{% endif %}
                    </div>
                    <span class="fw-bold fs-5 me-2">{{ p_data.final_score }}</span>
                </div>
            </button>
        </h2>
        <div id="p-collapse-{{ p_data.participation.id }}" class="accordion-collapse collapse" data-bs-parent="#participantAccordion-{{ contest.id }}-{{ exp_category }}">
            <div class="accordion-body bg-light">
                {# Детализация по судьям #}
                <ul class="list-group list-group-flush">
                {% for eval in p_data.judge_evaluations %}
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        <span class="text-muted"><i class="bi bi-clipboard-check-fill me-2"></i>{{ eval.judge.nickname or eval.judge.code }}</span>
                        <span class="fw-bold">{{ eval.judge_avg }}</span>
                    </li>
                {% else %}
                    <li class="list-group-item text-muted">Оценок нет.</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endfor %}
</div>